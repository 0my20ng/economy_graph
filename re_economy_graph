# âœ… ìˆ˜ìš”ê³¡ì„  ê³„ì‚° ì˜¤ë¥˜ ì™„ì „ ìˆ˜ì • ë²„ì „
# ìˆ˜ìš”ê³¡ì„ ê³¼ ê³µê¸‰ê³¡ì„ ì´ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ë„ë¡ ìˆ˜ì •

import tkinter as tk
from tkinter import messagebox
from tkinter import ttk
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.pyplot as plt
import numpy as np
from matplotlib.patches import Polygon

plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# âœ… ì‰ì—¬ ê³„ì‚° í•¨ìˆ˜
def consumer_surplus(a, b, p_eq, q_eq):
    """ì†Œë¹„ì ì‰ì—¬ ê³„ì‚°: aëŠ” ìˆ˜ìš”ê³¡ì„ ì˜ yì ˆí¸, bëŠ” ìˆ˜ìš”ê³¡ì„ ì˜ ê¸°ìš¸ê¸°(ì ˆëŒ“ê°’)"""
    return 0.5 * q_eq * (a - p_eq)

def producer_surplus(c, d, p_eq, q_eq):
    """ìƒì‚°ì ì‰ì—¬ ê³„ì‚°: cëŠ” ê³µê¸‰ê³¡ì„ ì˜ yì ˆí¸, dëŠ” ê³µê¸‰ê³¡ì„ ì˜ ê¸°ìš¸ê¸°"""
    return 0.5 * q_eq * (p_eq - c)

def calculate_surplus_shortage(a, b, c, d, control_price):
    """ê°€ê²©í†µì œ ì‹œ ì´ˆê³¼ìˆ˜ìš”/ê³µê¸‰ ê³„ì‚°"""
    qd = (a - control_price) / b if b > 0 else 0
    qs = (control_price - c) / d if d > 0 else 0
    qd = max(0, qd)
    qs = max(0, qs)
    
    if qd > qs:
        return "ì´ˆê³¼ ìˆ˜ìš”", qd - qs
    elif qs > qd:
        return "ì´ˆê³¼ ê³µê¸‰", qs - qd
    else:
        return "ê· í˜•", 0

# âœ… ì‹œì¥ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ (ì™„ì „ ìˆ˜ì •)
def simulate_market(ax, dq1, dp1, dq2, dp2, sq1, sp1, sq2, sp2, tax=0, subsidy=0, price_control_type=None, price_control=None):
    ax.clear()

    # ğŸ”§ ìˆ˜ìš”ê³¡ì„  íŒŒë¼ë¯¸í„° ê³„ì‚° (P = a - bQ í˜•íƒœ)
    if dq2 != dq1:
        # ìˆ˜ìš”ê³¡ì„ ì˜ ê¸°ìš¸ê¸° (ìŒìˆ˜ì—¬ì•¼ í•¨)
        demand_slope = (dp2 - dp1) / (dq2 - dq1)
        b = abs(demand_slope)  # ê¸°ìš¸ê¸°ì˜ ì ˆëŒ“ê°’
        # yì ˆí¸ ê³„ì‚°: ìˆ˜ìš”ê³¡ì„ ì´ yì¶•ê³¼ ë§Œë‚˜ëŠ” ì 
        a = dp1 + b * dq1
    else:
        b = 1
        a = dp1

    # ğŸ”§ ê³µê¸‰ê³¡ì„  íŒŒë¼ë¯¸í„° ê³„ì‚° (P = c + dQ í˜•íƒœ)
    if sq2 != sq1:
        d = (sp2 - sp1) / (sq2 - sq1)
        d = abs(d)  # ê¸°ìš¸ê¸°ëŠ” ì–‘ìˆ˜
        c = sp1 - d * sq1
    else:
        d = 1
        c = sp1

    # ê· í˜•ì  ê³„ì‚°
    net_tax = tax - subsidy
    
    # ê· í˜•ì : ìˆ˜ìš”ê³¡ì„ ê³¼ ê³µê¸‰ê³¡ì„ ì˜ êµì 
    # a - bQ = c + dQ ë¥¼ Qì— ëŒ€í•´ í’€ë©´
    denominator = b + d
    if denominator > 0:
        q_eq = (a - c) / denominator
        p_eq = a - b * q_eq
        
        # ì •ë¶€ê°œì… í›„ ê· í˜•ì 
        q_new = (a - c - d * net_tax) / denominator
        p_new = a - b * q_new
    else:
        q_eq = p_eq = q_new = p_new = 0

    # ê·¸ë˜í”„ìš© ë°ì´í„° ìƒì„±
    max_q = max(q_eq, q_new if tax != 0 or subsidy != 0 else 0, 100)
    quantities = np.linspace(0, max_q * 1.5, 500)
    
    # ìˆ˜ìš”ê³¡ì„ : P = a - bQ
    demand_prices = a - b * quantities
    
    # ê³µê¸‰ê³¡ì„ : P = c + dQ
    supply_prices = c + d * quantities
    
    # ì •ë¶€ê°œì… í›„ ê³µê¸‰ê³¡ì„ : P = c + dQ + ì„¸ê¸ˆ
    supply_prices_new = c + d * quantities + net_tax

    # ìŒìˆ˜ ê°€ê²© ì œê±°
    demand_prices = np.maximum(demand_prices, 0)
    supply_prices = np.maximum(supply_prices, 0)
    supply_prices_new = np.maximum(supply_prices_new, 0)

    # ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    ax.plot(quantities, demand_prices, label='ìˆ˜ìš”ê³¡ì„ ', color='blue', linewidth=2)
    ax.plot(quantities, supply_prices, label='ê³µê¸‰ê³¡ì„ ', color='green', linewidth=2)
    
    if tax != 0 or subsidy != 0:
        ax.plot(quantities, supply_prices_new, '--', label='ì •ë¶€ê°œì… í›„ ê³µê¸‰ê³¡ì„ ', color='red', linewidth=2)

    # ê· í˜•ì  í‘œì‹œ
    if q_eq > 0 and p_eq > 0:
        ax.scatter(q_eq, p_eq, color='purple', s=100, zorder=5, label=f'ì›ë˜ ê· í˜• ({q_eq:.1f}, {p_eq:.1f})')
    
    if (tax != 0 or subsidy != 0) and q_new > 0 and p_new > 0:
        ax.scatter(q_new, p_new, color='orange', s=100, zorder=5, label=f'ê°œì… í›„ ê· í˜• ({q_new:.1f}, {p_new:.1f})')

    # âœ… ì‰ì—¬ ê³„ì‚° ë° ì‹œê°í™”
    if q_eq > 0 and p_eq > 0:
        cs = consumer_surplus(a, b, p_eq, q_eq)
        ps = producer_surplus(c, d, p_eq, q_eq)
        
        # ì†Œë¹„ì ì‰ì—¬ (ìˆ˜ìš”ê³¡ì„  ì•„ë˜, ê· í˜•ê°€ê²© ìœ„ìª½ ì‚¼ê°í˜•)
        ax.fill_between([0, q_eq], [p_eq, p_eq], [a, p_eq], 
                       color='skyblue', alpha=0.3, label=f'ì†Œë¹„ì ì‰ì—¬: {cs:.1f}')
        
        # ìƒì‚°ì ì‰ì—¬ (ê³µê¸‰ê³¡ì„  ìœ„, ê· í˜•ê°€ê²© ì•„ë˜ìª½ ì‚¼ê°í˜•)
        ax.fill_between([0, q_eq], [c, c + d * q_eq], [p_eq, p_eq], 
                       color='lightgreen', alpha=0.3, label=f'ìƒì‚°ì ì‰ì—¬: {ps:.1f}')

        # DWL ê³„ì‚° (ì •ë¶€ê°œì…ì´ ìˆëŠ” ê²½ìš°)
        if tax != 0 or subsidy != 0:
            gov_revenue = tax * q_new if tax else -subsidy * q_new if subsidy else 0
            cs_new = consumer_surplus(a, b, p_new, q_new)
            ps_new = producer_surplus(c, d, p_new, q_new)
            
            total_original = cs + ps
            total_new = cs_new + ps_new + gov_revenue
            dwl = total_original - total_new
            
            if dwl > 0:
                ax.text(q_eq * 0.7, p_eq * 1.1, f'DWL: {dwl:.1f}', 
                       color='red', fontsize=10, weight='bold')

    # ê°€ê²©í†µì œ íš¨ê³¼
    if price_control_type in ['ceiling', 'floor'] and price_control is not None:
        ax.axhline(price_control, color='darkred', linestyle=':', linewidth=2,
                   label=f'{"ìµœê³ ê°€ê²©ì œ" if price_control_type=="ceiling" else "ìµœì €ê°€ê²©ì œ"}: {price_control}')
        
        surplus_type, amount = calculate_surplus_shortage(a, b, c, d, price_control)
        ax.text(max_q * 0.1, price_control + 2, f'{surplus_type}: {amount:.1f}', 
                fontsize=10, color='darkred', weight='bold')

    # ê³¡ì„  ë°©ì •ì‹ í‘œì‹œ (ë””ë²„ê¹…ìš©)
    ax.text(0.02, 0.95, f'ìˆ˜ìš”ê³¡ì„ : P = {a:.1f} - {b:.1f}Q', transform=ax.transAxes, 
            fontsize=9, bbox=dict(boxstyle="round,pad=0.3", facecolor="lightblue"))
    ax.text(0.02, 0.90, f'ê³µê¸‰ê³¡ì„ : P = {c:.1f} + {d:.1f}Q', transform=ax.transAxes, 
            fontsize=9, bbox=dict(boxstyle="round,pad=0.3", facecolor="lightgreen"))

    ax.set_xlabel('ìˆ˜ëŸ‰ (Q)')
    ax.set_ylabel('ê°€ê²© (P)')
    ax.set_title('ê°‘êµ­ ìƒí’ˆ A ì‹œì¥ ì‹œë®¬ë ˆì´ì…˜')
    ax.legend(loc='upper right')
    ax.grid(True, alpha=0.3)
    
    # ì¶• ë²”ìœ„ ì„¤ì •
    ax.set_xlim(0, max_q * 1.2)
    ax.set_ylim(0, max(a, supply_prices.max()) * 1.1)

# âœ… GUI êµ¬í˜„
def run_gui():
    def on_submit():
        try:
            vals = {k: float(entries[k].get()) for k in entries}
            control_type = control_type_var.get()
            control_value = float(control_price_entry.get()) if control_type != 'none' else None
            
            simulate_market(ax,
                            vals['ìˆ˜ìš” Q1'], vals['ìˆ˜ìš” P1'], vals['ìˆ˜ìš” Q2'], vals['ìˆ˜ìš” P2'],
                            vals['ê³µê¸‰ Q1'], vals['ê³µê¸‰ P1'], vals['ê³µê¸‰ Q2'], vals['ê³µê¸‰ P2'],
                            vals['ì„¸ê¸ˆ'], vals['ë³´ì¡°ê¸ˆ'],
                            control_type if control_type != 'none' else None, control_value)
            canvas.draw()
        except Exception as e:
            messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", f"ë‹¤ìŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n{e}")

    root = tk.Tk()
    root.title("ì‹œì¥ ì‹œë®¬ë ˆì´ì…˜ ì…ë ¥")
    root.geometry("1400x800")

    entries = {}
    labels = ['ìˆ˜ìš” Q1', 'ìˆ˜ìš” P1', 'ìˆ˜ìš” Q2', 'ìˆ˜ìš” P2', 'ê³µê¸‰ Q1', 'ê³µê¸‰ P1', 'ê³µê¸‰ Q2', 'ê³µê¸‰ P2', 'ì„¸ê¸ˆ', 'ë³´ì¡°ê¸ˆ']
    defaults = [0, 100, 50, 0, 0, 0, 50, 100, 0, 0]  # ë” ëª…í™•í•œ ê¸°ë³¸ê°’
    
    for i, label in enumerate(labels):
        tk.Label(root, text=label).grid(row=i, column=0, sticky='w', padx=5, pady=2)
        entry = tk.Entry(root)
        entry.insert(0, str(defaults[i]))
        entry.grid(row=i, column=1, padx=5, pady=2)
        entries[label] = entry

    # ê°€ê²©í†µì œ ì˜µì…˜
    tk.Label(root, text='ì •ë¶€ê°œì…').grid(row=10, column=0, sticky='w', padx=5, pady=2)
    control_type_var = tk.StringVar(value='none')
    control_type_combo = ttk.Combobox(root, textvariable=control_type_var, 
                                      values=['none', 'ceiling', 'floor'], state='readonly')
    control_type_combo.grid(row=10, column=1, padx=5, pady=2)

    tk.Label(root, text='ê°€ê²©í†µì œ').grid(row=11, column=0, sticky='w', padx=5, pady=2)
    control_price_entry = tk.Entry(root)
    control_price_entry.insert(0, '0')
    control_price_entry.grid(row=11, column=1, padx=5, pady=2)

    tk.Button(root, text="ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰", command=on_submit).grid(row=12, columnspan=2, pady=10)

    fig, ax = plt.subplots(figsize=(12, 8))
    canvas = FigureCanvasTkAgg(fig, master=root)
    canvas.get_tk_widget().grid(row=0, column=2, rowspan=13, padx=10, pady=10)

    # ì´ˆê¸° ì‹¤í–‰
    on_submit()

    root.mainloop()

if __name__ == '__main__':
    run_gui()
